<!doctype html>
<html lang="en">

<head>
    <title>购物车-书店管理</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <!-- VENDOR CSS -->
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap-dialog/css/bootstrap-dialog.min.css">
    <link rel="stylesheet" href="../assets/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/vendor/linearicons/style.css">
    <link rel="stylesheet" href="../assets/vendor/chartist/css/chartist-custom.css">
    <!-- MAIN CSS -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <!-- FOR DEMO PURPOSES ONLY. You should remove this in your project -->
    <link rel="stylesheet" href="../assets/css/demo.css">
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet">
    <!-- ICONS -->
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/favicon.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../assets/img/favicon.png">
</head>

<body class="layout-fullwidth">
<!-- WRAPPER -->
<div id="wrapper">
    <!-- NAVBAR -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="brand">
            <a href="/book"><img src="/assets/img/logo-dark.png" alt="Klorofil Logo" class="img-responsive logo"></a>
        </div>
        <div class="container-fluid">
            <form class="navbar-form navbar-left">
                <div class="input-group">
                    <input v-model="key" type="text" value="" class="form-control" placeholder="Search ...">
                    <span @click="toSearch" class="input-group-btn"><button type="button" class="btn btn-primary">Go</button></span>
                </div>
            </form>
            <div id="navbar-menu">
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a id="book-cart" href="/cart"><i class="lnr lnr-cart"></i> <span>购物车</span></a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><img src="/assets/img/user.png" class="img-circle" alt="Avatar"> <span>{{ username }}</span> <i class="icon-submenu lnr lnr-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="/order"><i class="lnr lnr-cog"></i> <span>我的订单</span></a></li>
                            <li><a href="/api/account/logout"><i class="lnr lnr-exit"></i> <span>退出</span></a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- END NAVBAR -->

    <!-- MAIN -->
    <div class="main">
        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="container-fluid">

                <h3 class="page-title">购物车</h3>

                <div class="row">
                    <div class="col-md-12">
                        <!-- TABLE HOVER -->
                        <div class="panel">
                            <div class="panel-body">

                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>选择</th>
                                            <th>书名</th>
                                            <th>价格</th>
                                            <th>剩余数量</th>
                                            <th>预购</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="book in books">
                                            <td><input v-model="book.selected" type="checkbox"></td>
                                            <td>{{ book.bookName }}</td>
                                            <td>￥{{ book.price }}</td>
                                            <td>{{ book.leftCount }}</td>
                                            <td>{{ book.stock == true ? '否' : '是' }}</td>
                                        </tr>
                                    </tbody>
                                </table>

                            </div>
                        </div>
                        <!-- END TABLE HOVER -->

                    </div>
                </div>

                <!-- 模态框（Modal） -->
                <div class="modal fade" id="addressModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="addressModalLabel">填写收货地址</h4>
                            </div>
                            <div class="modal-body">
                                <div class="input-group">
                                    <span class="input-group-addon">Address</span>
                                    <input v-model="address" type="text" class="form-control" placeholder="请输入详细地址">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                <button @click="applyOrder" type="button" class="btn btn-primary">购买</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal -->
                </div>

            </div>
        </div>
        <!-- END MAIN CONTENT -->
    </div>

    <!-- END MAIN -->
    <div class="clearfix"></div>
    <footer>
        <div class="container-fluid">
            <button data-toggle="modal" data-target="#addressModal" class="btn btn-danger">购买</button>
        </div>
    </footer>

</div>
<!-- END WRAPPER -->
</body>

<!-- Javascript -->
<script src="../assets/vendor/jquery/jquery.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="../assets/vendor/bootstrap-dialog/js/bootstrap-dialog.min.js"></script>
<script src="../assets/vendor/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="../assets/vendor/jquery.easy-pie-chart/jquery.easypiechart.min.js"></script>
<script src="../assets/vendor/chartist/js/chartist.min.js"></script>
<script src="../assets/vendor/vue/vue.js"></script>
<script src="../assets/vendor/vue/vue-resource.js"></script>
<script src="../assets/js/common.js"></script>
<script src="../assets/js/api.js"></script>

<script>
    let app = new Vue({
        el: '#wrapper',
        data: {
            username: localStorage.username,
            books: [],
            address: '',
            key: ''
        },
        methods: {
            applyOrder() {
                let vm = this;
                let ids = [];
                this.books.forEach((book) =>{
                    if (book.selected) ids.push(book.id);
                });
                let reqData = {
                    books: ids,
                    address: vm.address
                };

                this.$http.post(api.cart.purchase, reqData)
                    .then(resp => {
                        let result = resp.body;
                        if (result.success) {
                            BootstrapDialog.alert("下单成功", () => {
                                window.location.href = "/order/" + result.data;
                            });
                        } else {
                            console.log(resp);
                        }
                    }).catch(resp => {
                        console.log(resp);
                    })
            },
            toSearch() {
                window.location.href = '/search/' + this.key;
            },
            fetchBookData() {
                let vm = this;

                this.$http.get(api.cart.list)
                    .then(resp => {
                        let result = resp.body;
                        if (result.success) {
                            vm.books = result.data;
                        } else {
                            console.log(resp);
                        }
                    })
            }
        },
        created() {
            this.fetchBookData();
        }
    })
</script>

</html>
