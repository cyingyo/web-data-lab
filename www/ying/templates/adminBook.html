<!doctype html>
<html lang="en">

<head>
    <title>书店管理</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <!-- VENDOR CSS -->
    <link rel="stylesheet" href="/assets/vendor/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/vendor/bootstrap-dialog/css/bootstrap-dialog.min.css">
    <link rel="stylesheet" href="/assets/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/vendor/linearicons/style.css">
    <!-- MAIN CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">
    <!-- FOR DEMO PURPOSES ONLY. You should remove this in your project -->
    <link rel="stylesheet" href="/assets/css/demo.css">
    <link rel="stylesheet" href="/assets/css/checkbox.css">
    <!-- GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" rel="stylesheet">
    <!-- ICONS -->
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicon.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicon.png">
</head>

<body>
<!-- WRAPPER -->
<div id="wrapper">
    <!-- NAVBAR -->
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="brand">
            <a href="index.html"><img src="/assets/img/logo-dark.png" alt="Klorofil Logo" class="img-responsive logo"></a>
        </div>
        <div class="container-fluid">
            <div class="navbar-btn">
                <button type="button" class="btn-toggle-fullwidth"><i class="lnr lnr-arrow-left-circle"></i></button>
            </div>
            <div id="navbar-menu">
                <ul class="nav navbar-nav navbar-right">
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="lnr lnr-question-circle"></i> <span>帮助</span> <i class="icon-submenu lnr lnr-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="#">基本使用</a></li>
                            <li><a href="#">数据</a></li>
                            <li><a href="#">安全性</a></li>
                            <li><a href="#">问题排查</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown"><img src="/assets/img/user.png" class="img-circle" alt="Avatar"> <span>管理员</span> <i class="icon-submenu lnr lnr-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="/api/account/logout"><i class="lnr lnr-exit"></i> <span>退出</span></a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- END NAVBAR -->

    <!-- LEFT SIDEBAR -->
    <div id="sidebar-nav" class="sidebar">
        <div class="sidebar-scroll">
            <nav>
                <ul class="nav">
                    <li><a href="/admin/index" class=""><i class="lnr lnr-home"></i> <span>控制面板</span></a></li>
                    <li><a href="/admin/account" class=""><i class="lnr lnr-code"></i> <span>用户管理</span></a></li>
                    <li><a href="/admin/book" class="active"><i class="lnr lnr-chart-bars"></i> <span>书籍管理</span></a></li>
                    <li><a href="/admin/order" class=""><i class="lnr lnr-chart-bars"></i> <span>订单管理</span></a></li>
                </ul>
            </nav>
        </div>
    </div>
    <!-- END LEFT SIDEBAR -->

    <!-- MAIN -->
    <div class="main">
        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="container-fluid">
                <h3 style="display: inline-block" class="page-title">书籍</h3>
                <div style="text-align:right;">
                    <button data-toggle="modal" data-target="#createModal" class="btn btn-info">新增书籍</button>
                </div>

                <div class="row">
                    <div class="col-md-12">
                        <!-- TABLE HOVER -->
                        <div class="panel">
                            <div class="panel-body">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>id</th>
                                            <th>书名</th>
                                            <th>作者</th>
                                            <th>剩余</th>
                                            <th>管理</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="book, index in books">
                                            <td>{{ book.id }}</td>
                                            <td>《{{ book.bookName }}》</td>
                                            <td>{{ book.authorName }}</td>
                                            <td>{{ book.leftCount }}</td>
                                            <td><button @click="openUpdate(index)" class="btn btn-primary">管理</button></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- END TABLE HOVER -->
                    </div>
                </div>

                <!-- 模态框（Modal） -->
                <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" >
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="updateModalLabel">管理书籍</h4>
                            </div>
                            <div class="modal-body">
                                <div class="input-group">
                                    <span class="input-group-addon">书名   </span>
                                    <input v-model="targetBook.bookName" type="text" class="form-control" placeholder="请输入书名">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">作者名 </span>
                                    <input v-model="targetBook.authorName" type="text" class="form-control" placeholder="请输入作者名">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">描述   </span>
                                    <input v-model="targetBook.description" type="text" class="form-control" placeholder="请输入描述">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">封面地址</span>
                                    <input v-model="targetBook.imgUrl" type="text" class="form-control" placeholder="请输入封面地址">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">库存数 </span>
                                    <input v-model="targetBook.leftCount" type="text" class="form-control only-integer" placeholder="请输入库存数">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">价格   </span>
                                    <input v-model="targetBook.price" type="text" class="form-control only-float" placeholder="请输入价格">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">是否折扣</span>
                                    <div class="checkbox checkbox-success">
                                        <input v-model="targetBook.discount" id="checkbox1" type="checkbox">
                                        <label for="checkbox1">
                                            折扣
                                        </label>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">折扣比例</span>
                                    <input v-model="targetBook.discountAmount" type="text" class="form-control only-less-one" placeholder="请输入折扣比例">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">正在销售</span>
                                    <div class="checkbox checkbox-success">
                                        <input v-model="targetBook.stock" id="checkbox2" type="checkbox">
                                        <label for="checkbox2">
                                            销售（否则为预售）
                                        </label>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">销售日期</span>
                                    <input v-model="targetBook.stockDate" type="date" class="form-control">
                                </div>
                                <img :src="targetBook.imgUrl" class="img-responsive center-block" />
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button @click="deleteBook()" type="button" class="btn btn-danger">删除</button>
                                <button @click="updateBook()" type="button" class="btn btn-primary">确认</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal -->
                </div>

                <!-- 模态框（Modal） -->
                <div class="modal fade" id="createModal" tabindex="-1" role="dialog" >
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                <h4 class="modal-title" id="createModalLabel">新增书籍</h4>
                            </div>
                            <div class="modal-body">
                                <div class="input-group">
                                    <span class="input-group-addon">书名   </span>
                                    <input v-model="newBook.bookName" type="text" class="form-control" placeholder="请输入书名">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">作者名 </span>
                                    <input v-model="newBook.authorName" type="text" class="form-control" placeholder="请输入作者名">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">描述   </span>
                                    <input v-model="newBook.description" type="text" class="form-control" placeholder="请输入描述">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">封面地址</span>
                                    <input v-model="newBook.imgUrl" type="text" class="form-control" placeholder="请输入描述">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">库存数 </span>
                                    <input v-model="newBook.leftCount" type="text" class="form-control only-integer" placeholder="请输入库存数">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">价格   </span>
                                    <input v-model="newBook.price" type="text" class="form-control only-float" placeholder="请输入价格">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">是否折扣</span>
                                    <div class="checkbox checkbox-success">
                                        <input v-model="newBook.discount" id="checkbox3" type="checkbox">
                                        <label for="checkbox1">
                                            折扣
                                        </label>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">折扣比例</span>
                                    <input v-model="newBook.discountAmount" type="text" class="form-control only-less-one" placeholder="请输入折扣比例">
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">正在销售</span>
                                    <div class="checkbox checkbox-success">
                                        <input v-model="newBook.stock" id="checkbox4" type="checkbox">
                                        <label for="checkbox2">
                                            销售（否则为预售）
                                        </label>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <span class="input-group-addon">销售日期</span>
                                    <input v-model="newBook.stockDate" type="date" class="form-control">
                                </div>
                                <img :src="newBook.imgUrl" class="img-responsive center-block" />
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button @click="createBook()" type="button" class="btn btn-primary">确认</button>
                            </div>
                        </div><!-- /.modal-content -->
                    </div><!-- /.modal -->
                </div>

            </div>
        </div>
        <!-- END MAIN CONTENT -->
    </div>
    <!-- END MAIN -->
    <div class="clearfix"></div>
    <footer>
        <div class="container-fluid">
        </div>
    </footer>
</div>
<!-- END WRAPPER -->
</body>

<!-- Javascript -->
<script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/assets/vendor/bootstrap-dialog/js/bootstrap-dialog.min.js"></script>
<script src="/assets/vendor/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<script src="/assets/vendor/vue/vue.js"></script>
<script src="/assets/vendor/vue/vue-resource.js"></script>
<script src="/assets/js/common.js"></script>
<script src="/assets/js/api.js"></script>
<script>
    let app = new Vue({
        el: '#wrapper',
        data: {
            books: [],
            targetBook: {},
            newBook: {}
        },
        methods: {
            openUpdate(index) {
                this.targetBook = this.books[index];

                $('#updateModal').modal('show');
            },
            deleteBook() {
                this.$http.delete(api.admin.book.delete + this.targetBook.id)
                    .then(resp => {
                        let result = resp.body;
                        if (result.success) {
                            BootstrapDialog.alert("删除成功", () => {
                                location.reload();
                            })
                        } else {
                            BootstrapDialog.alert("删除失败")
                        }
                    });
                $('#updateModal').modal('hide');
            },
            updateBook() {
                if (!this.checkFormat(this.targetBook)) {
                    BootstrapDialog.alert("请检查输入项，输入项不能为空!");
                    return;
                }
                let vm = this;
                this.$http.put(api.admin.book.update + this.targetBook.id, this.targetBook)
                    .then(resp => {
                        let result = resp.body;
                        if (result.success) {
                            BootstrapDialog.alert("修改成功")
                        } else {
                            BootstrapDialog.alert("修改失败")
                        }
                    });
                $('#updateModal').modal('hide');
            },
            createBook() {
                if (!this.checkFormat(this.newBook)) {
                    BootstrapDialog.alert("请检查输入项，输入项不能为空!");
                    return;
                }
                let vm = this;
                this.$http.post(api.admin.book.add, this.newBook)
                    .then(resp => {
                        let result = resp.body;
                        if (result.success) {
                            BootstrapDialog.alert("新建成功", () => {
                                location.reload();
                            });
                        } else {
                            BootstrapDialog.alert("新建失败")
                        }
                    });
                $('#createModal').modal('hide');
            },
            fetchBookData() {
                let vm = this;

                this.$http.get(api.admin.book.list)
                    .then(resp => {
                        let result = resp.body;

                        if (result.success) {
                            vm.books = result.data;
                        } else {
                            console.log(resp);
                        }
                    })
            },
            checkFormat(jsonData) {
                if (jsonData.bookName == null || jsonData.bookName == '') {
                    return false;
                }
                if (jsonData.authorName == null || jsonData.authorName == '') {
                    return false;
                }
                if (jsonData.description == null || jsonData.description == '') {
                    return false;
                }
                if (jsonData.imgUrl == null || jsonData.imgUrl == '') {
                    return false;
                }
                if (jsonData.leftCount == null || jsonData.leftCount == '') {
                    return false;
                }
                if (jsonData.price == null || jsonData.price == '') {
                    return false;
                }

                return true;
            }
        },
        created() {
            this.fetchBookData();
        },
        mounted() {
            $('.only-integer').keyup(function () {
                this.value = this.value.replace(/\D/g,'');
            });
            
            $('.only-float').keyup(function () {
                if (this.value == '') {
                    this.t_value = '';
                    return;
                }
                if(!this.value.match(/^[1-9]\d*\.?(\d{1,2})?$/))
                    this.value = this.t_value === undefined ? '' : this.t_value;
                else
                    this.t_value = this.value;
            });

            $('.only-less-one').keyup(function () {
                if (this.value == '') {
                    this.t_value = '';
                    return;
                }
                if(!this.value.match(/^0\.(\d{1,2})?$|^0$/))
                    this.value = this.t_value === undefined ? '' : this.t_value;
                else
                    this.t_value = this.value;
            })
        }
    })
</script>
</html>
